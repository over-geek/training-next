module.exports=[33731,a=>{"use strict";a.s(["default",()=>w],33731);var b=a.i(87924),c=a.i(72131),d=a.i(50944),e=a.i(26251),f=a.i(63588),g=a.i(60246),h=a.i(76803),i=a.i(17756),i=i,j=a.i(25015);let k=(0,a.i(70106).default)("square",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}]]);var l=a.i(96221),m=a.i(40695),n=a.i(3130),o=a.i(88237),p=a.i(19721),q=a.i(38246),r=a.i(94697),s=a.i(23292),t=a.i(43205);let u=new class{ws=null;reconnectAttempts=0;maxReconnectAttempts=5;reconnectDelay=3e3;heartbeatInterval=null;trainingId=null;onAttendanceUpdate=null;onError=null;constructor(){}connect(a,b,c){if(this.ws?.readyState===WebSocket.OPEN)return void console.log("WebSocket already connected");this.trainingId=a,this.onAttendanceUpdate=b,this.onError=c;try{let a=this.getToken();if(!a)throw Error("No authentication token found");this.ws=new WebSocket(`ws://${t.OAUTH_BASE_URL}/ws?token=${a}`),this.ws.onopen=()=>{console.log("WebSocket connection established"),this.reconnectAttempts=0,this.send({type:"PING"}),this.startHeartbeat(),s.toast.success("Connected to real-time attendance system")},this.ws.onmessage=a=>{try{let b=JSON.parse(a.data);this.handleMessage(b)}catch(a){console.error("Error processing WebSocket message:",a)}},this.ws.onclose=a=>{console.log("WebSocket connection closed",a.code,a.reason),this.stopHeartbeat(),1e3!==a.code&&this.reconnectAttempts<this.maxReconnectAttempts&&this.attemptReconnect()},this.ws.onerror=a=>{console.error("WebSocket error:",a),s.toast.error("Connection error. Attempting to reconnect...")}}catch(a){console.error("Failed to connect to WebSocket:",a),this.onError?.("Failed to connect to attendance system")}}handleMessage(a){switch(a.type){case"ATTENDANCE":if(a.data){let b={employeeName:a.data.name,employeeDepartment:a.data.department,createdOn:new Date().toISOString()};this.onAttendanceUpdate?.(b),s.toast.success(`New Attendee: ${b.employeeName}`,{description:`${b.employeeDepartment} department`})}break;case"ERROR":this.onError?.(a.message||"Unknown error occurred"),s.toast.error("Attendance Error",{description:a.message||"Unknown error occurred"});break;case"PONG":break;default:console.log("Unhandled message type:",a.type)}}startHeartbeat(){this.heartbeatInterval=setInterval(()=>{this.ws?.readyState===WebSocket.OPEN&&this.send({type:"PING"})},15e3)}stopHeartbeat(){this.heartbeatInterval&&(clearInterval(this.heartbeatInterval),this.heartbeatInterval=null)}attemptReconnect(){this.reconnectAttempts++,console.log(`Attempting to reconnect (${this.reconnectAttempts}/${this.maxReconnectAttempts})`),setTimeout(()=>{this.trainingId&&this.onAttendanceUpdate&&this.onError&&this.connect(this.trainingId,this.onAttendanceUpdate,this.onError)},this.reconnectDelay)}send(a){this.ws?.readyState===WebSocket.OPEN&&this.ws.send(JSON.stringify(a))}getToken(){return null}disconnect(){this.stopHeartbeat(),this.ws&&(this.ws.close(1e3,"Manual disconnect"),this.ws=null),this.trainingId=null,this.onAttendanceUpdate=null,this.onError=null,this.reconnectAttempts=0}isConnected(){return this.ws?.readyState===WebSocket.OPEN}};var v=a.i(3060);function w(){let a=Number((0,d.useParams)().id),[p,t]=(0,c.useState)(null),[w,x]=(0,c.useState)(null),[y,z]=(0,c.useState)(0),[A,B]=(0,c.useState)(null),[C,D]=(0,c.useState)(1),[E,F]=(0,c.useState)(!0),[G,H]=(0,c.useState)(!1),[I,J]=(0,c.useState)(!1);(0,c.useEffect)(()=>(K(),()=>{u.disconnect()}),[a]),(0,c.useEffect)(()=>{p?.status==="in-progress"?P():u.disconnect()},[p?.status,a]);let K=async()=>{try{F(!0);let b=await r.TrainingService.getTrainingSessionById(a);t(b);let c=await r.TrainingService.getAttendanceLogs(a);x(c);let d=await r.TrainingService.getTrainingResponses(a);z(d.length);let e=await r.TrainingService.getTrainingMetrics(b.trainingName);B(e)}catch(a){console.error("Failed to fetch training data:",a),s.toast.error("Failed to load training details. Please try again.")}finally{F(!1)}},L=w?.attendees||[],M=Math.ceil(L.length/5),N=(C-1)*5,O=L.slice(N,N+5),P=()=>{u.isConnected()||u.connect(a.toString(),Q,R)},Q=a=>{x(b=>b?b.attendees.some(b=>b.employeeName===a.employeeName)?b:{...b,attendees:[...b.attendees,{employeeName:a.employeeName,employeeDepartment:a.employeeDepartment,createdOn:a.createdOn}]}:b)},R=a=>{console.error("WebSocket error:",a),s.toast.error("Connection Error",{description:a})},S=async()=>{if(p)try{H(!0),await Promise.all([r.TrainingService.startTrainingSession(p.id),r.TrainingService.updateTrainingSession({id:p.id,status:"in-progress"})]),t(a=>a?{...a,status:"in-progress"}:null),s.toast.success("Training session started successfully!")}catch(a){console.error("Failed to start training session:",a),console.error("Error details:",{message:a?.message,status:a?.status,response:a?.response?.data}),s.toast.error("Failed to start training session",{description:a?.message||"Please try again."})}finally{H(!1)}},T=async()=>{if(p)try{H(!0),u.disconnect(),await Promise.all([r.TrainingService.endTrainingSession(p.id),r.TrainingService.updateTrainingSession({id:p.id,status:"done"})]),t(a=>a?{...a,status:"done"}:null),s.toast.success("Training session ended successfully!")}catch(a){console.error("Failed to end training session:",a),console.error("Error details:",{message:a?.message,status:a?.status,response:a?.response?.data}),s.toast.error("Failed to end training session",{description:a?.message||"Please try again."})}finally{H(!1)}},U=async()=>{if(p)try{await r.TrainingService.exportResponsesZIP(p.id),s.toast.success("Evaluation responses exported successfully!")}catch(a){console.error("Failed to export responses:",a),s.toast.error("Failed to export responses",{description:a?.message||"Please try again."})}};return!p&&E?(0,b.jsx)("div",{className:"p-6 flex items-center justify-center min-h-[400px]",children:(0,b.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,b.jsx)(l.Loader2,{className:"h-6 w-6 animate-spin"}),(0,b.jsx)("span",{className:"text-lg",children:"Loading training details..."})]})}):p?(0,b.jsxs)("div",{className:"p-6 space-y-6",children:[(0,b.jsxs)(q.default,{href:"/trainings",className:"flex items-center text-sm text-muted-foreground mb-4 hover:underline",children:[(0,b.jsx)(i.default,{className:"h-4 w-4 mr-1"}),"Back to Trainings"]}),(0,b.jsxs)("div",{className:"flex justify-between items-center",children:[(0,b.jsxs)("div",{className:"flex items-center gap-4",children:[(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)("p",{className:"font-medium",children:"Agenda:"}),(0,b.jsx)("span",{children:p.trainingName})]}),(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)("p",{className:"font-medium",children:"Facilitator:"}),(0,b.jsx)("span",{children:p.facilitator})]})]}),(()=>{if(!p)return null;let a=p.status;return"upcoming"===a?(0,b.jsxs)("div",{className:"space-x-2",children:[(0,b.jsxs)(m.Button,{variant:"outline",disabled:!0,children:[(0,b.jsx)(f.MessageSquare,{className:"h-4 w-4 mr-2"}),"Take Responses"]}),(0,b.jsxs)(m.Button,{onClick:S,disabled:G,children:[G?(0,b.jsx)(l.Loader2,{className:"h-4 w-4 mr-2 animate-spin"}):(0,b.jsx)(j.Play,{className:"h-4 w-4 mr-2"}),"Start Session"]})]}):"in-progress"===a?(0,b.jsxs)("div",{className:"space-x-2",children:[(0,b.jsxs)(m.Button,{variant:"outline",onClick:()=>J(!0),children:[(0,b.jsx)(f.MessageSquare,{className:"h-4 w-4 mr-2"}),"Take Responses"]}),(0,b.jsxs)(m.Button,{onClick:T,disabled:G,children:[G?(0,b.jsx)(l.Loader2,{className:"h-4 w-4 mr-2 animate-spin"}):(0,b.jsx)(k,{className:"h-4 w-4 mr-2"}),"End Session"]})]}):(0,b.jsxs)("div",{className:"space-x-2",children:[(0,b.jsxs)(m.Button,{variant:"outline",onClick:()=>J(!0),children:[(0,b.jsx)(f.MessageSquare,{className:"h-4 w-4 mr-2"}),"Take Responses"]}),(0,b.jsxs)(m.Button,{onClick:U,children:[(0,b.jsx)(e.FileDown,{className:"h-4 w-4 mr-2"}),"Export Responses"]})]})})()]}),(0,b.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[(0,b.jsxs)(n.Card,{className:"h-40",children:[(0,b.jsxs)(n.CardHeader,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[(0,b.jsx)(n.CardTitle,{className:"text-sm font-medium",children:"Total Attendees"}),(0,b.jsx)(g.Users,{className:"h-4 w-4 text-muted-foreground"})]}),(0,b.jsx)(n.CardContent,{children:(0,b.jsx)("div",{className:"text-2xl font-bold",children:E?(0,b.jsx)(l.Loader2,{className:"h-6 w-6 animate-spin"}):L.length})})]}),(0,b.jsxs)(n.Card,{className:"h-40",children:[(0,b.jsxs)(n.CardHeader,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[(0,b.jsx)(n.CardTitle,{className:"text-sm font-medium",children:"Total Responses"}),(0,b.jsx)(h.ClipboardCheck,{className:"h-4 w-4 text-muted-foreground"})]}),(0,b.jsx)(n.CardContent,{children:(0,b.jsx)("div",{className:"text-2xl font-bold",children:E?(0,b.jsx)(l.Loader2,{className:"h-6 w-6 animate-spin"}):y})})]}),(0,b.jsx)(n.Card,{className:"col-span-1 md:col-span-1 lg:col-span-1 h-40 p-0",children:(0,b.jsx)(n.CardContent,{children:(0,b.jsx)("div",{className:"h-[150px] flex items-center justify-center",children:E?(0,b.jsx)(l.Loader2,{className:"h-6 w-6 animate-spin"}):(A&&A.attendeeCount.length,(0,b.jsx)("p",{className:"text-sm text-muted-foreground",children:"No attendance data"}))})})}),(0,b.jsx)(n.Card,{className:"col-span-1 md:col-span-1 lg:col-span-1 p-0",children:(0,b.jsx)(n.CardContent,{children:(0,b.jsx)("div",{className:"h-[150px] flex items-center justify-center",children:E?(0,b.jsx)(l.Loader2,{className:"h-6 w-6 animate-spin"}):(A&&A.departmentBreakdown.length,(0,b.jsx)("p",{className:"text-sm text-muted-foreground",children:"No department data"}))})})})]}),(0,b.jsx)(n.Card,{children:(0,b.jsxs)(n.CardContent,{children:[(0,b.jsxs)(o.Table,{children:[(0,b.jsx)(o.TableHeader,{children:(0,b.jsxs)(o.TableRow,{children:[(0,b.jsx)(o.TableHead,{children:"Name"}),(0,b.jsx)(o.TableHead,{children:"Department"}),(0,b.jsx)(o.TableHead,{children:"Check-in Time"})]})}),(0,b.jsx)(o.TableBody,{children:E?(0,b.jsx)(o.TableRow,{children:(0,b.jsx)(o.TableCell,{colSpan:3,className:"text-center py-8",children:(0,b.jsxs)("div",{className:"flex items-center justify-center space-x-2",children:[(0,b.jsx)(l.Loader2,{className:"h-4 w-4 animate-spin"}),(0,b.jsx)("span",{className:"text-muted-foreground",children:"Loading attendance data..."})]})})}):O.length>0?O.map((a,c)=>{let d=new Date(a.createdOn).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",second:"2-digit"});return(0,b.jsxs)(o.TableRow,{children:[(0,b.jsx)(o.TableCell,{className:"font-medium",children:a.employeeName}),(0,b.jsx)(o.TableCell,{children:a.employeeDepartment}),(0,b.jsx)(o.TableCell,{children:d})]},`${a.employeeName}-${c}`)}):(0,b.jsx)(o.TableRow,{children:(0,b.jsx)(o.TableCell,{colSpan:3,className:"text-center py-8 text-muted-foreground",children:"No attendance records found"})})})]}),M>1&&(0,b.jsxs)("div",{className:"flex items-center justify-between space-x-2 py-4",children:[(0,b.jsxs)("div",{className:"text-sm text-muted-foreground",children:["Showing ",N+1," to ",Math.min(N+5,L.length)," of ",L.length," attendees"]}),(0,b.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,b.jsx)(m.Button,{variant:"outline",size:"sm",onClick:()=>D(a=>Math.max(a-1,1)),disabled:1===C,children:"Previous"}),(0,b.jsx)("div",{className:"flex items-center space-x-1",children:Array.from({length:M},(a,b)=>b+1).map(a=>(0,b.jsx)(m.Button,{variant:C===a?"default":"outline",size:"sm",onClick:()=>D(a),className:"w-8 h-8 p-0",children:a},a))}),(0,b.jsx)(m.Button,{variant:"outline",size:"sm",onClick:()=>D(a=>Math.min(a+1,M)),disabled:C===M,children:"Next"})]})]})]})}),(0,b.jsx)(v.QRCodeDialog,{isOpen:I,onClose:()=>J(!1),trainingId:a,trainingName:p?.trainingName})]}):(0,b.jsxs)("div",{className:"p-6",children:[(0,b.jsxs)(q.default,{href:"/trainings",className:"flex items-center text-sm text-muted-foreground mb-4 hover:underline",children:[(0,b.jsx)(i.default,{className:"h-4 w-4 mr-1"}),"Back to Trainings"]}),(0,b.jsx)("div",{className:"text-center py-8",children:(0,b.jsx)("p",{className:"text-muted-foreground",children:"Training not found"})})]})}(0,p.default)(async()=>{},{loadableGenerated:{modules:[76250]},ssr:!1}),(0,p.default)(async()=>{},{loadableGenerated:{modules:[39249]},ssr:!1})}];

//# sourceMappingURL=app_trainings_%5Bid%5D_page_tsx_798396dd._.js.map